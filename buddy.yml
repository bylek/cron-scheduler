- pipeline: "Build docker images"
  trigger_mode: "MANUAL"
  ref_name: "master"
  actions:
  - action: "Prepare frontend"
    type: "BUILD"
    docker_image_name: "library/node"
    docker_image_tag: "7"
    execute_commands:
    - "cd client"
    - "npm install"
    - "ng build -e docker"
    - "rm -rf ../docker/frontend/dist && mv dist ../docker/frontend"
    setup_commands:
    - "npm install -g @angular/cli"
  - action: "Build frontend image"
    type: "DOCKERFILE"
    login: "${docker_login}"
    password: "${docker_password}"
    docker_image_tag: "latest"
    dockerfile_path: "docker/frontend/Dockerfile"
    context_path: "docker/frontend/"
    repository: "bylek/cron-frontend"
  - action: "Prepare backend"
    type: "BUILD"
    docker_image_name: "library/node"
    docker_image_tag: "7"
    execute_commands:
    - "cp config/prod.json config/default.json"
    - "cp -r config/ models/ routes/ services/ package.json app.js docker/backend/"
  - action: "Build backend image"
    type: "DOCKERFILE"
    login: "${docker_login}"
    password: "${docker_password}"
    docker_image_tag: "latest"
    dockerfile_path: "docker/backend/Dockerfile"
    context_path: "docker/backend/"
    repository: "bylek/cron-backend"
  - action: "Build haproxy image"
    type: "DOCKERFILE"
    login: "${docker_login}"
    password: "${docker_password}"
    docker_image_tag: "latest"
    dockerfile_path: "docker/haproxy/Dockerfile"
    context_path: "docker/haproxy/"
    repository: "bylek/cron-haproxy"
  - action: "Build mysql image"
    type: "DOCKERFILE"
    login: "${docker_login}"
    password: "${docker_password}"
    docker_image_tag: "latest"
    dockerfile_path: "docker/mysql/Dockerfile"
    context_path: "docker/mysql/"
    repository: "bylek/cron-mysql"
